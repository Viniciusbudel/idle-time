# Audit Remediation Plan (Warnings + Errors)

Date: 2026-02-27  
Source report: `.agent/audit-report.json` (generated by `.agent/scripts/audit-app.py`)

## Status (After P0 Implemented)

- Before P0: high=21, medium=37, low=15 (total=73)
- After P0: high=0, medium=2, low=15 (total=17)
- Implemented in `.agent/scripts/audit-app.py`:
- URL scanner now ignores internal docs/workflow paths and known platform namespace/DTD URLs.
- `Random()` findings now trigger only in security-sensitive contexts.
- After P1 implemented: high=0, medium=2, low=3 (test-only low findings)
- P2 implemented: added `docs/SECURITY-NOTES.md`.
- P3 implemented: added `.github/workflows/security-audit.yml` (fails only on high severity).
- Added suppression config support and default file: `.agent/audit-ignore.json`.
- Current filtered audit result: high=0, medium=0, low=0 (total=0).

## 1. Audit Summary

- Total findings: 73
- Errors (high): 21
- Warnings (medium): 37
- Warnings (low): 15

Rule breakdown:

- `URL_HTTP_ANY`: 21 (high)
- `DART_INSECURE_RANDOM`: 35 (medium)
- `DART_PRINT_LOG`: 15 (low)
- `ANDROID_EXPORTED`: 1 (medium)
- `PKG_SHARED_PREFS`: 1 (medium)

## 2. Triage (What is real vs noisy)

### High (`URL_HTTP_ANY`) - mostly false positives

Current hits are from:

- Android XML namespace URLs (`http://schemas.android.com/...`)
- Apple plist DTD URLs (`http://www.apple.com/...`)
- Internal docs/workflows in `.agent/**` using `http://localhost:3000`

Plan:

- Treat current 21 findings as scanner noise, not production endpoint risk.
- Improve scanner rule so these patterns are excluded.

### Medium (`DART_INSECURE_RANDOM`) - mostly non-security gameplay randomness

Current hits are from animation/gameplay randomness and UI positioning, not auth/session/token generation.

Plan:

- Keep `Random()` for non-security gameplay/visual behavior.
- Add explicit guidance and suppression strategy for approved non-security contexts.
- Add a stricter rule for security-sensitive contexts only (token, key, auth, password, session, nonce, etc.).

### Medium (`ANDROID_EXPORTED`) - expected for launcher activity

`android:exported="true"` in `MainActivity` is required because it has the launcher intent filter.

Plan:

- Keep as-is.
- Add allowlist/suppression note for this exact case to avoid repeated noise.

### Medium (`PKG_SHARED_PREFS`) - review item, not immediate defect

`shared_preferences` is used for game save state (not credentials/secrets).

Plan:

- Keep usage.
- Document that secrets must not be stored there.
- Optional: add lightweight integrity check/signature for save payload to detect tampering.

### Low (`DART_PRINT_LOG`) - actionable hygiene

Production code still has `print/debugPrint` calls.

Plan:

- Replace direct prints with a centralized logger that is gated in release.
- Keep verbose logs in tests only.

## 3. Fix Plan by Priority

## P0 - Make audit output accurate

1. Patch audit rules to reduce false positives.
2. Exclude `.agent/**`, `docs/**`, platform XML namespace URLs, and plist DTD URLs from `URL_HTTP_ANY`.
3. Reclassify insecure randomness findings as:
4. `HIGH/MEDIUM` only when randomness appears in security-sensitive contexts.
5. `INFO` for pure game/animation randomness.
6. Add optional suppression config file (for example `.agent/audit-ignore.json`) with rule + path globs.

Acceptance criteria:

- High findings drop from 21 to only true app-security issues.
- Report highlights actionable items first.

## P1 - Production log hardening

Target files:

- `lib/core/services/growth_analytics_service.dart`
- `lib/core/services/notification_service.dart`
- `lib/core/services/save_service.dart`
- `lib/presentation/game/components/worker_avatar.dart`
- `lib/presentation/game/time_factory_game.dart`
- `lib/presentation/ui/templates/video_background.dart`

Steps:

1. Create a small `AppLog` wrapper.
2. Gate logs with `kDebugMode` (or compile-time flag).
3. Remove sensitive payload logging or redact values.
4. Keep test logging under `test/**` unchanged.

Acceptance criteria:

- No `print/debugPrint` findings in `lib/**`.
- Behavior unchanged in debug mode.

## P2 - Document accepted security posture

1. Add `docs/SECURITY-NOTES.md`:
2. `shared_preferences` is for non-secret game state.
3. `MainActivity` exported launcher rationale.
4. `Random()` acceptable usage boundaries.
5. Add short checklist for new features:
6. No hardcoded secrets/tokens.
7. No HTTP production endpoints.
8. No sensitive logs in release.

Acceptance criteria:

- Security decisions are explicit and reviewable.

## P3 - CI enforcement

1. Add CI step to run audit script and store JSON artifact.
2. Fail build only on non-ignored high findings.
3. Keep medium/low as advisory in CI output.

Acceptance criteria:

- Audit runs automatically.
- New real high findings block merges.

## 4. Implementation Order (Recommended)

1. Audit script precision fixes (`P0`).
2. Logger cleanup in `lib/**` (`P1`).
3. Security notes documentation (`P2`).
4. CI gate (`P3`).
5. Re-run audit and attach before/after counts in PR.

## 5. Already Fixed During This Run

- Fixed crash in `.agent/scripts/audit-app.py` path exclusion logic (`is_excluded`) so the audit runs on Windows paths.
- Implemented P0 signal/noise improvements in audit detection logic.
- Implemented P1 logging hardening in `lib/**` via `AppLog`.
- Implemented P2 security posture documentation.
- Implemented P3 CI security-audit gate.
- Added ignore-rule handling (`--ignore-file`) and default suppression config.
